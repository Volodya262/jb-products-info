# Jb products info (Тестовое задание jetbrains toolbox enterprise)
## Общая информация
По расписанию или по запросу загружает список продуктов и билдов из https://www.jetbrains.com/updates/updates.xml и
https://data.services.jetbrains.com/products, скачивает *.tar.gz дистрибутивы, находит в них product-info.json 
и сохраняет в БД. Более подробное описание процесса находится в разделе "Описание процесса".

Предполагается использование 1 инстанса с профилем api и N инстансов с профилем worker.

## Команды для работы
Должен быть установлен docker и docker-compose. 
Все команды должны выполняться из консоли с java 17 и выше.  

Если установлен sdkman, ```sdk use java 17.0.4.fx-librca```.

- **Запустить окружение для прогона тестов и разработки** ```docker-compose up```
- **lint, build, test** ```./gradlew build```
- **Запустить приложение (профиль default)** ```./gradlew bootRun```
- Запустить только линтер ```./gradlew ktlintCheck```
- Попробовать исправить ошибки линта ```./gradlew ktlintFormat```

### Запустить несколько инстансов приложения
Собрать приложение в jar ```./gradlew bootJar```

Далее, в отдельных терминалах:

Запустить api 

```java -jar ./build/libs/jb-products-info-1.jar --spring.profiles.active=default_api```

Запустить worker1 

```java -jar ./build/libs/jb-products-info-1.jar --server.port=12001 --spring.profiles.active=default_worker```

Запустить worker2 

```java -jar ./build/libs/jb-products-info-1.jar --server.port=12002 --spring.profiles.active=default_worker```

И т.д.

## Описание процесса
### 1. Выделить список продуктов и билдов из двух источников (XML, JSON)
Далее источник https://www.jetbrains.com/updates/updates.xml будем называть xml, 
а https://data.services.jetbrains.com/products - json. 

Загрузить xml и json файлы с информацией о билдах. 
В xml хранится интересующий нас список билдов, в json - ссылки на дистрибутивы. 
Список продуктов и билдов в каждом отличается, поэтому данные надо объединить.

Блок product в xml описывает семейство продуктов (family group) и кодов (code) может быть несколько, 
при этом количество кодов не обязательно соответствует количеству продуктов. 
Также, у каждого build есть ```buildNumber``` и, опционально, ```fullBuildNumber```. 

Например, 
- Intellij IDEA в xml имеет коды IC, IU и соответствует двум изданиям продукта: 
Intellij IDEA Ultimate и Community. 
- DataSpell имеет два кода DS, PD, но соответствует одному продукту - DataSpell
- PyCharm имеет коды PC, PCA, PY, PYA и соответствует двум продуктам - PyCharm Professional Edition и PyCharm Community Edition.

Json состоит из продуктов, при этом у продукта есть ```code``` и, опционально, ```intellijProductCode```, 
массив ```alternativeCodes``` и ```salesCode```. У продукта есть список релизов, а у каждого релиза - поле ```build```.

Далее, для каждого продукта из json находится группа продуктов со списком билдов.
Если продукт не найден - он не сохраняется в БД и не анализируется.
Для каждого билда из json - соответствующий билд из xml. 
Если билд не найден - он не сохраняется и не анализируется.

### 2. Добавление в очередь списка билдов
Полученный список продуктов и соответствующий каждому из них список билдов сохраняется в БД. 
Идентификаторы билдов (```productCode``` и ```buildFullNumber```) отправляются 
в Kafka-топик ```BUILDS_TO_PROCESS``` (далее очередь), который слушают инстансы с профилем worker. 

Билд для обработки представляет из себя сущность-агрегат из событий (```Created```, ```Queued```, ```Processing``` и т.д.)

Некоторые билды невозможно обработать (например, у них нет дистрибутива для Linux), они сохраняются в БД 
со статусом ```FailedToConstruct``` и не отправляются в очередь.

### 3. Обработка билда
Инстанс с профилем ```worker``` слушает очередь. При получении нового сообщения, 
worker проверяет актуальность задания, скачивает дистрибутив в tmp директорию,
ищет в нём файл ```product-info.json``` и сохраняет его содержимое в сущность-агрегат.

Сущность-агрегат переводится в статус ```Processed``` и сохраняется в БД. 

Если файл не удалось скачать, открыть или файл не был найден - сущность 
переводится в статус ```FailedToProcess``` с указанием соответствующей ошибки. 

### 4. Получение результатов анализа и текущих активностей сервиса
В любой момент времени можно вызвать ручку ```/``` или ```/status```, в которых описывается
информация об известных продуктах и соответствующим им билдам. 